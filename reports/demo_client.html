<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fatigue XR Replay Demo</title>
    <style>
      body { font-family: "Segoe UI", Tahoma, sans-serif; margin: 20px; }
      .row { margin-bottom: 10px; }
      label { display: inline-block; width: 140px; }
      input { padding: 6px; width: 260px; }
      button { padding: 8px 16px; }
      #status { font-size: 32px; margin: 16px 0; }
      #actionChanged { color: #b00020; font-weight: bold; height: 20px; }
      #log { border: 1px solid #ccc; padding: 10px; height: 260px; overflow-y: auto; background: #fafafa; }
      #wsUrl { font-family: monospace; background: #f3f3f3; padding: 6px; display: inline-block; }
      #banner { background: #0f172a; color: #fff; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; }
      #banner code { color: #fff; }
    </style>
  </head>
  <body>
    <div id="banner">
      <div style="font-size:18px;font-weight:600;">Server running</div>
      <div style="opacity:0.85;">WebSocket endpoint: <code>/ws/replay</code></div>
      <div style="opacity:0.85;">Example: <code>ws://127.0.0.1:8000/ws/replay?participant_id=ID01&amp;condition=dual&amp;session_id=ID01_ET_0&amp;speed=10</code></div>
    </div>

    <h1>Fatigue XR Replay Demo</h1>

    <div class="row">
      <label>Participant</label>
      <input id="participantId" value="ID01" />
    </div>
    <div class="row">
      <label>Condition</label>
      <input id="condition" value="dual" />
    </div>
    <div class="row">
      <label>Session ID</label>
      <input id="sessionId" value="ID01_ET_0" />
    </div>
    <div class="row">
      <label>Window Len</label>
      <input id="windowLen" value="10" />
    </div>
    <div class="row">
      <label>Stride</label>
      <input id="stride" value="1" />
    </div>
    <div class="row">
      <label>Speed</label>
      <input id="speed" value="10" />
    </div>
    <div class="row">
      <label>Max Steps</label>
      <input id="maxSteps" value="" placeholder="(optional)" />
    </div>
    <div class="row">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div class="row">
      <label>WS URL</label>
      <span id="wsUrl">--</span>
    </div>

    <div id="status">Score: -- | State: -- | Action: --</div>
    <div id="actionChanged"></div>
    <div id="log"></div>

    <script>
      let ws = null;
      const logEl = document.getElementById("log");
      const statusEl = document.getElementById("status");
      const actionChangedEl = document.getElementById("actionChanged");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const wsUrlEl = document.getElementById("wsUrl");

      function appendLog(line) {
        const item = document.createElement("div");
        item.textContent = line;
        logEl.appendChild(item);
        while (logEl.children.length > 200) {
          logEl.removeChild(logEl.firstChild);
        }
        logEl.scrollTop = logEl.scrollHeight;
      }

      function buildWsUrl() {
        const participantId = document.getElementById("participantId").value.trim();
        const condition = document.getElementById("condition").value.trim();
        const sessionId = document.getElementById("sessionId").value.trim();
        const speed = document.getElementById("speed").value.trim();
        const maxSteps = document.getElementById("maxSteps").value.trim();
        const windowLen = document.getElementById("windowLen").value.trim();
        const stride = document.getElementById("stride").value.trim();

        const params = new URLSearchParams({
          participant_id: participantId,
          condition: condition,
          session_id: sessionId,
          speed: speed || "10",
          window_len_sec: windowLen || "10",
          stride_sec: stride || "1",
        });
        if (maxSteps) {
          params.set("max_steps", maxSteps);
        }

        const proto = (location.protocol === "https:") ? "wss" : "ws";
        const base = `${proto}://${location.host}`;
        return `${base}/ws/replay?${params.toString()}`;
      }

      function connect() {
        const wsUrl = buildWsUrl();
        wsUrlEl.textContent = wsUrl;
        appendLog(`Connecting to ${wsUrl}`);

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          appendLog("Connected.");
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
        };

        ws.onerror = () => {
          appendLog("WebSocket error (see console)");
        };

        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.event === "completed") {
            appendLog("Completed normally.");
            disconnectBtn.disabled = true;
            connectBtn.disabled = false;
            return;
          }
          if (msg.error) {
            appendLog(`Error: ${msg.error} ${msg.detail || ""}`.trim());
            return;
          }
          const score = Number(msg.score).toFixed(3);
          statusEl.textContent = `Score: ${score} | State: ${msg.state} | Action: ${msg.action}`;
          if (msg.action_changed) {
            actionChangedEl.textContent = "Action changed!";
            setTimeout(() => { actionChangedEl.textContent = ""; }, 1000);
          }
          appendLog(`[${Number(msg.window_end_sec).toFixed(1)}] ${msg.state} ${msg.action} score=${score}`);
        };

        ws.onclose = (event) => {
          if (event.code === 1000) {
            appendLog("Closed normally (code=1000).");
          } else {
            appendLog(`Closed code=${event.code} reason=${event.reason || ""}`.trim());
          }
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      connectBtn.addEventListener("click", connect);
      disconnectBtn.addEventListener("click", disconnect);
    </script>
  </body>
</html>
